<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Kubernetes By Example</title>
  <meta property="og:title" content="Kubernetes By Example" />
  <meta name="twitter:title" content="Kubernetes By Example" />
  <meta name="description" content="Exposing Applications for Internal Access Objectives After completing this section, you should be able to enable intra-pod network communications for applications deployed in Kubernetes, and learn how to keep communication up even with automatic deployments.
Kubernetes Networking When pods are created, they are assigned an IP address. You use this IP to access the pod from anywhere within the Kubernetes cluster. Containers inside a pod share the same network space, which means that, within the pod, containers can communicate with each other by using the localhost address.">
  <meta property="og:description" content="Exposing Applications for Internal Access Objectives After completing this section, you should be able to enable intra-pod network communications for applications deployed in Kubernetes, and learn how to keep communication up even with automatic deployments.
Kubernetes Networking When pods are created, they are assigned an IP address. You use this IP to access the pod from anywhere within the Kubernetes cluster. Containers inside a pod share the same network space, which means that, within the pod, containers can communicate with each other by using the localhost address.">
  <meta name="twitter:description" content="Exposing Applications for Internal Access Objectives After completing this section, you should be able to enable intra-pod network communications for applications deployed in Kubernetes, and learn how â€¦">
  <meta name="author" content=""/>
  <link href='https://tonejito.github.io/kbe/img/kbe-logo.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://tonejito.github.io/kbe/img/kbe-logo.png" />
  <meta name="twitter:image" content="https://tonejito.github.io/kbe/img/kbe-logo.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://tonejito.github.io/kbe/learning-paths/application-development/lesson-3/expose-internal/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Kubernetes By Example" />

  <meta name="generator" content="Hugo 0.91.2" />
  <link rel="canonical" href="https://tonejito.github.io/kbe/learning-paths/application-development/lesson-3/expose-internal/" />
  <link rel="alternate" href="https://tonejito.github.io/index.xml" type="application/rss+xml" title="Kubernetes By Example">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://tonejito.github.io/kbe//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://tonejito.github.io/kbe//css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://tonejito.github.io/kbe//css/highlight.min.css" />
<link rel="stylesheet" type="text/css" href="https://tonejito.github.io/kbe/css/custom.css">


<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WNHKJNX');</script>
  
</head>

  <body>
    
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WNHKJNX"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
<nav class="navbar navbar-default navbar-fixed-top navbar-custom" style="padding: 0px">

  

  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://tonejito.github.io/">Home</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Other topics</a>
              <div class="navlinks-children">
                
                  <a href="/kbe/topics/metallb/metallb/">MetalLB</a>
                
                  <a href="/kbe/topics/istio/istio/">Istio</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Concepts</a>
              <div class="navlinks-children">
                
                  <a href="/kbe/concepts/pods">Pods</a>
                
                  <a href="/kbe/concepts/labels">Labels</a>
                
                  <a href="/kbe/concepts/deployments">Deployments</a>
                
                  <a href="/kbe/concepts/services">Services</a>
                
                  <a href="/kbe/concepts/port-forwarding">Port Forwarding</a>
                
                  <a href="/kbe/concepts/health-checks">Health Checks</a>
                
                  <a href="/kbe/concepts/environment-variables">Environment Variables</a>
                
                  <a href="/kbe/concepts/namespaces">Namespaces</a>
                
                  <a href="/kbe/concepts/volumes">Volumes</a>
                
                  <a href="/kbe/concepts/persistent-volumes">Persistent Volumes</a>
                
                  <a href="/kbe/concepts/secrets">Secrets</a>
                
                  <a href="/kbe/concepts/logging">Logging</a>
                
                  <a href="/kbe/concepts/jobs">Jobs</a>
                
                  <a href="/kbe/concepts/nodes">Nodes</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Hands-on Examples</a>
              <div class="navlinks-children">
                
                  <a href="/kbe/sd/">Service Discovery</a>
                
                  <a href="/kbe/pf/">Port Forward</a>
                
                  <a href="/kbe/statefulset/">Stateful Sets</a>
                
                  <a href="/kbe/ic/">Init Containers</a>
                
                  <a href="/kbe/api/">API Server</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="Contribute" href="https://github.com/openshift-evangelists/kbe.git">Contribute</a>
            </li>
          
        
          
            <li>
              <a title="Try out!" href="/kbe/diy/">Try out!</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Kubernetes By Example" href="https://tonejito.github.io/">
            <img class="avatar-img" src="https://tonejito.github.io/kbe//img/kbe-logo.png" alt="Kubernetes By Example" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  <div class="intro-header"></div>


    
  <div class="container" role="main">
    <!-- https://kubebyexample.com/en/learning-paths/application-development-kubernetes/lesson-3-networking-kubernetes/exposing -->
<h1 id="exposing-applications-for-internal-access">Exposing Applications for Internal Access</h1>
<h2 id="objectives">Objectives</h2>
<p>After completing this section, you should be able to enable intra-pod network communications for applications deployed in Kubernetes, and learn how to keep communication up even with automatic deployments.</p>
<h2 id="kubernetes-networking">Kubernetes Networking</h2>
<p>When pods are created, they are assigned an IP address. You use this IP to access the pod from anywhere within the Kubernetes cluster. Containers inside a pod share the same network space, which means that, within the pod, containers can communicate with each other by using the localhost address.</p>
<p>A Kubernetes cluster might be split across different nodes. A node is a physical machine where resources run. A cluster is a logical view of a set of nodes. These nodes are different machines, but they work together as a logical unit. This makes it easier to work with different machines at the same time because you can simply deploy resources to the cluster and not to individual nodes.</p>
<p><img src="https://kubebyexample.com/sites/default/files/2021-06/pod-to-pod.svg_.png" alt=""></p>
<p>Image
Pod to pod communication
Figure 1. Networking in a Kubernetes cluster</p>
<h2 id="introducing-kubernetes-services">Introducing Kubernetes Services</h2>
<p>In a real world environment, deployments are performed on a daily basis. When bugs are fixed or new features are added to an application, a new image version is created and deployed. This means that pods are constantly created and destroyed (the pods of the older version are removed and new pods are allocated for the newer version).</p>
<p>At the same time, applications usually have several replicas and traffic is split across the replicas. This ensures that no single replica is overworked. This is called load-balancing.</p>
<p>In both use cases, the problem is the same: you need a way to reach the pods regardless of the machine where they are located. To solve this, Kubernetes introduces the concept of Service.</p>
<p>A service is an abstraction that defines the access to a set of pods. By using a service, you don&rsquo;t access pods directly through their private IP addresses. Instead, a service targets several pods based on certain criteria (for example, a label) and forwards any requests to one of the pods matching that criteria.</p>
<p>In other words, a service allows you to group pods with a logical relationship and it allows you to reach them in a reliable way. At the same time, it implements a load-balancing mechanism among the pods that it targets.</p>
<p><img src="https://kubebyexample.com/sites/default/files/2021-06/service-redirect-static.svg_.png" alt=""></p>
<p>Image
Service static redirect
Figure 2. A service redirecting traffic to pod replicas.</p>
<p>For example, if you want to have three replicas of your application then three pods will be created. If you create a service that targets these pods, then the service receives any incoming requests and it routes it to one of them.</p>
<p>By default, a service is given a cluster-internal IP address, which is only valid within the cluster. This type of service is called ClusterIP. This means that pods deployed in the cluster can make requests to the service by using the ClusterIP.</p>
<p>The following diagram illustrates the communication between pods and services. For example, Pod 1 uses the ClusterIP of Service 2 to make requests to the service.</p>
<p><img src="https://kubebyexample.com/sites/default/files/2021-06/pod-to-service.svg_.png" alt=""></p>
<p>Image
Pod to service communication
Figure 3. Pod communication using services</p>
<p>If you want to expose the service externally, then you can use other types of services such as NodePort or LoadBalancer. However, the most common way to expose a service outside of your cluster is by using another Kubernetes resource called Ingress. Ingress is covered in upcoming sections of this course.</p>
<h2 id="creating-kubernetes-services">Creating Kubernetes Services</h2>
<p>When creating a service, it is necessary to define the port that the service will serve on. This port is mapped to a target port inside the pod that the service targets. Incoming requests to the service in port are forwarded to the target port in the pod. If no target port is provided, then the port value is used.</p>
<p>There are two ways to create a service in Kubernetes:</p>
<ul>
<li><strong>Using <code>kubectl expose</code></strong></li>
</ul>
<p>The easiest way to create a service is by using the kubectl expose command.</p>
<pre><code class="language-bash">[user@host ~]$ kubectl expose deployment deployment-name \
    --port=8081 --name=service-name --target-port=3000
</code></pre>
<p>The previous command creates a service named service-name, which targets deployment deployment-name. It listens on port 80 and it points to port 3000 inside the pod.</p>
<p>Use the command kubectl get service to list the services available. The output will provide you with information such as the ClusterIP (IP only valid within the Kubernetes cluster) and the port used to access the service. A sample output might look like this:</p>
<pre><code class="language-text">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service-name   ClusterIP   10.108.68.139   &lt;none&gt;        80/TCP     3s
</code></pre>
<ul>
<li><strong>Applying a manifest</strong></li>
</ul>
<p>An approach in line with the DevOps principles is creating services through a manifest. The following sample creates a service named nginx-service and targets any pod with the label app: nginx. The service listens for requests in port 8080 and forwards them to port 3000 inside the pod. Because the manifest does not include the type field, it creates a service with type ClusterIP.</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: nginx-service  &lt;1&gt;
spec:
  selector:  &lt;2&gt;
    app: nginx
  ports:  &lt;3&gt;
    - protocol: TCP
      port: 8081  &lt;4&gt;
      targetPort: 3000  &lt;5&gt;
</code></pre>
<ol>
<li>
<p>Name of the service</p>
</li>
<li>
<p>Labels used to select the target pods</p>
</li>
<li>
<p>Port mapping</p>
</li>
<li>
<p>The port that the service will serve on</p>
</li>
<li>
<p>The port inside the pod where requests are forwarded</p>
</li>
</ol>
<h2 id="discovering-kubernetes-services">Discovering Kubernetes Services</h2>
<p>A service abstracts your application from knowing the exact location of the pods you are using, but you still need to know the IP of the service to use it from your application. Directly using the IP is a bad idea because if the IP changes in the future, then you would need to manually update it in your application. To avoid this, Kubernetes provides two ways to discover services:</p>
<ul>
<li><strong>Environment variables</strong></li>
</ul>
<p>By default, when a service is created, Kubernetes injects some environment variables in pods within the same namespace. These variables follow the pattern:</p>
<pre><code class="language-text">SERVICE-NAME_VARIABLE-NAME
</code></pre>
<p>If you have a service named nginx-provider, that generates the following variables (non-exhaustive) then you can simply inject these environment variables into your application:</p>
<ul>
<li>
<p><code>NGINX_PROVIDER_SERVICE_HOST</code>, which contains the IP address of the Service. For example, <code>10.0.0.11</code></p>
</li>
<li>
<p><code>NGINX_PROVIDER_SERVICE_PORT</code>, which contains the port where Service listens on. For example, <code>6379</code></p>
</li>
</ul>
<p>However, your application tries to fetch the environment variables only on start-up. This means that if the value of the variable changes (for example, a service gets a different IP) after your application has started, then your application is not notified and it references an invalid value (the previous IP address of the service). The same happens if the service is created after your application boots-up.</p>
<ul>
<li><strong>DNS</strong></li>
</ul>
<p>Given the limitations of the Kubernetes built-in environment variables, the preferred way of accessing services from your application is using DNS.</p>
<p>Every service in the cluster is assigned a DNS name, which matches with the service&rsquo;s lower cased name. This allows applications to access services using always the same reference. The default FQDN follows the pattern:</p>
<pre><code class="language-text">service.namespace.svc.cluster.local
</code></pre>
<p>However, it is possible to avoid this long form. The DNS server also resolves the following hosts:</p>
<ul>
<li>
<p><code>service.namespace.cluster.local</code></p>
</li>
<li>
<p><code>service.namespace</code></p>
</li>
<li>
<p><code>service</code> (in this case, Kubernetes expects the service to be in the same namespace)</p>
</li>
</ul>
<p>For example, if you have a service named nginx-service that exposes an HTTP endpoint in the default HTTP port (80), then you can use <code>http://nginx-service</code> if your application is in the same namespace as the service. If the service was in a namespace named nginx-apps, then you use <code>http://nginx-service.nginx-apps</code>.</p>

  </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
          &nbsp;&bull;&nbsp;
          2020

          
            &nbsp;&bull;&nbsp;
            <a href="https://tonejito.github.io/">Kubernetes By Example</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.91.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://tonejito.github.io/kbe//js/main.js"></script>
<script>

$('.language-test').parent().css('display', 'none')


var copybtns = {
  fallbackCopyTextToClipboard: function (text) {
    var txt = document.createElement("textarea");
    txt.value = text;
    
    
    txt.style.position = "fixed";
    txt.style.top = "0";
    txt.style.left = "0";
  
    document.body.appendChild(txt);
    txt.focus();
    txt.select();
    txt.setSelectionRange(0, 99999);
  
    try {
      var successful = document.execCommand('copy');
      var msg = successful ? 'successful' : 'unsuccessful';
    } catch (err) {
      console.error('Fallback: Unable to copy', err);
    }
  
    document.body.removeChild(txt);
  },
  copyTextToClipboard: function (text) {
    if (!navigator.clipboard) {
      copybtns.fallbackCopyTextToClipboard(text);
      return;
    }
    navigator.clipboard.writeText(text).then(function() {
      
    }, function(err) {
      
      copybtns.fallbackCopyTextToClipboard(text);
    });
  },
  flash: function(btn, content){
    
    content.fadeTo(50, 0.25, function() { $(this).fadeTo(300, 1.0); });
    
    btn.fadeTo(50, 0.0, function() { $(this).fadeTo(900, 1.0); });
  },
  txtClick : function(){
    var content = $(this);
    var btn = content.prev('button');
    
    copybtns.flash(btn, content);
    
    copybtns.copyTextToClipboard(content.text());
  },
  btnClick : function(){
    var btn = $(this);
    var content = $(btn.next().children()[0]);
    
    copybtns.flash(btn, content)
    
    copybtns.copyTextToClipboard(content.text());
  },
  init : function() {
    var buttonHTML = '<button type="button" data-toggle="tooltip" data-placement="top" title="Copy" class="copybtn btn btn-outline-dark"><img src="https:\/\/tonejito.github.io\/kbe\//img/Icon-Red_Hat-Media_and_documents-Paper_Stack_Blank-A-Black-RGB.png"/></button>';
    
    $('div.highlight').prepend(buttonHTML);
    
    $('button.copybtn').bind("click", copybtns.btnClick);
    $('div.highlight pre').bind("click", copybtns.txtClick);
  }
}
copybtns.init();
</script>
<script src="https://tonejito.github.io/kbe//js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-34425776-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

<div class="watermark-container">
  <div class="watermark">
    For testing purposes only
  </div>
  <div style="clear: both;"></div>
</div>



  </body>
</html>

